package be.msec.government;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.io.PrintWriter;
import java.nio.file.Paths;
import java.security.KeyStore;
import java.security.NoSuchAlgorithmException;
import java.security.PublicKey;
import java.security.Security;
import java.security.cert.CertificateException;

import javax.crypto.Cipher;
import javax.net.ssl.SSLSocket;
import javax.net.ssl.SSLSocketFactory;

import com.sun.net.ssl.internal.ssl.Provider;

public class TimestampClientTest {

	public static void main(String[] args) throws Exception {
		String governmentAddress = "localhost";
		int governmentPort = 443;

		// find keystore
		String keyStorePath = Paths.get(System.getProperty("user.dir")).getParent().toString() + File.separator
				+ "Certificates" + File.separator;
		String governmentKeyStore = keyStorePath + "client.jks";
		String governmentKeyPassword = "password";

		// set security properties
		Security.addProvider(new Provider());
		System.setProperty("javax.net.ssl.trustStore", governmentKeyStore);
		System.setProperty("javax.net.ssl.trustStorePassword", governmentKeyPassword);

		// optional: show details about handshake
		// System.setProperty("javax.net.debug", "all");

		SSLSocketFactory factory = (SSLSocketFactory) SSLSocketFactory.getDefault();
		SSLSocket socket = (SSLSocket) factory.createSocket(governmentAddress, governmentPort);

		BufferedReader in = new BufferedReader(new InputStreamReader(socket.getInputStream()));
		
		// test write something
		PrintWriter out = new PrintWriter(new OutputStreamWriter(socket.getOutputStream()));
		out.println("GET " + governmentAddress + " HTTP/1.1");
		out.println();
		out.flush();

		String line;
		String output = "";

		while ((line = in.readLine()) != null) {
			output += line;
		}
		
		// close connections
		in.close();
		out.close();

		// get certificate
		KeyStore keyStore = KeyStore.getInstance("JKS");
		FileInputStream fis = new FileInputStream(governmentKeyStore);
		keyStore.load(fis, governmentKeyPassword.toCharArray());
		fis.close();

		PublicKey pk = keyStore.getCertificate("government").getPublicKey();

		// decrypt
		String alg = "RSA";
		Cipher c = Cipher.getInstance(alg);
		c.init(Cipher.DECRYPT_MODE, pk);
		byte[] decrypted = c.doFinal(output.getBytes());
		long givenTime = Long.parseLong(new String(decrypted));

	}

}
